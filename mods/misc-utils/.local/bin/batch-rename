#!/bin/bash
#
# Copyright (c) Max Kagamine
# Licensed under the Apache License, Version 2.0
#
set -eo pipefail

# shellcheck source=mods/bash/.local/lib/common.sh
. ~/.local/lib/common.sh

help() {
  cat >&2 <<'EOF'
Usage: batch-rename [-n] <perl expression> <files...>

Helper for quickly applying a perl substitution to filenames.

Equivalent to:

  for f in <files...>; do
    mv -nv "$f" "$(perl -pe <perl expression> <<<"$f")" || break
  done

Files are passed to perl as given, including directories.

Options:

  -n, --dry-run    Dry run.
EOF
  exit 1
}

dry_run=

parse_args \
  -n,--dry-run 'dry_run=1' \
  -h,--help \
  -- "$@"

if (( ${#REST[@]} < 2 )); then
  help
fi

for f in "${REST[@]:1}"; do
  dest=$(perl -pe "${REST[0]}" <<<"$f")

  if [[ $dry_run ]]; then
    printf "would rename '%s' -> '%s'\n" "$f" "$dest"
  else
    mv -nv "$f" "$dest"
  fi
done

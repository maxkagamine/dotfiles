#!/bin/bash
#
# Copyright (c) Max Kagamine
# Licensed under the Apache License, Version 2.0
#
set -eo pipefail

# shellcheck source=mods/bash/.local/lib/common.sh
. ~/.local/lib/common.sh

help() {
  cat >&2 <<'EOF'
Usage: append-crc [-n] <file>...

Adds (or updates) a file's CRC32 hash to its filename.

Options:

  -n, --dry-run    Dry run.
EOF
  exit 1
}

dry_run=

parse_args \
  -n,--dry-run 'dry_run=1' \
  -h,--help \
  -- "$@"

for f in "${REST[@]}"; do
  crc=$(crc32 "$f" | cut -f1)
  name=$(perl -pe 's/^(.*?)( ?\[[0-9a-f]{8}\])?(\.[^\.]+)?$/\1 ['"$crc"']\3/' <<<"$f")

  if [[ $dry_run ]]; then
    [[ $f != "$name" ]] && echo "$f -> $name"
  else
    mv -nv "$f" "$name"
  fi
done

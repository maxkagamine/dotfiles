#!/bin/bash
#
# Copyright (c) Max Kagamine
# Licensed under the Apache License, Version 2.0
#
set -eo pipefail

# shellcheck source=mods/bash/.local/lib/common.sh
. ~/.local/lib/common.sh

CURL_OPTS=(
  -A 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/108.0.0.0 Safari/537.36'
  -H 'Accept-Language: en-US,en;q=0.9'
)

help() {
  cat >&2 <<'EOF'
Usage: mkmoviedir <imdb or mydramalist url> [<file>]

Creates a directory in the format "Title (Year)" with the poster saved to
folder.jpg (hidden). If the directory already exists but a folder.jpg doesn't,
it'll download the poster only.

Works for TV shows too.
EOF
  exit 1
}

imdb_url=
mdl_url=
files=()

parse_args \
  -h,--help \
  -- "$@"

for x in "${REST[@]}"; do
  case $x in
    https://www.imdb.com/*)
      if [[ ! $x =~ ^https://www.imdb.com/title/tt[[:digit:]]+ ]]; then
        throw 'unrecognized imdb url'
      fi
      imdb_url=${BASH_REMATCH[0]}
      ;;
    https://mydramalist.com/*)
      if [[ ! $x =~ ^https://mydramalist.com/[[:digit:]]+-[^/]+ ]]; then
        throw 'unrecognized mydramalist url'
      fi
      mdl_url=${BASH_REMATCH[0]}
      ;;
    http://*|https://*)
      throw 'unrecognized url'
      ;;
    *)
      files+=("$x")
      ;;
  esac
  shift
done

fetch_data() { # <url> <title suffix>, sets $html, $title, $image
  local url=$1
  local title_suffix=$2

  if ! html=$(curl "${CURL_OPTS[@]}" -sSL "$url"); then
    throw 'failed to fetch page'
  fi

  if ! title=$(grep -Po '(?<=<title>).*?(?='"$title_suffix"')' <<<"$html" | head -n1 | html-unescape); then
    throw 'failed to extract title'
  fi

  if ! image=$(grep -Po '(?<=<meta property="og:image" content=")[^"]+' <<<"$html"); then
    throw 'failed to extract og:image from page'
  fi
}

if [[ $imdb_url ]]; then
  fetch_data "$imdb_url" ' - IMDb'
elif [[ $mdl_url ]]; then
  fetch_data "$mdl_url" ' - MyDramaList'
else
  throw 'need either an imdb url or a mydramalist url'
fi

dir=$(sanitize-filename -- "$title")

mkdir -pv "$dir"

folderjpg="$dir/folder.jpg"

if [[ -e "$folderjpg" ]]; then
  echo 'folder.jpg already exists' >&2
else
  curl "${CURL_OPTS[@]}" -fsSL "$image" -o "$folderjpg"

  # Hide folder.jpg if on Windows
  if command -v wslpath &>/dev/null; then
    folderjpg_win=$(wslpath -w "$folderjpg")
    attrib.exe +h "$folderjpg_win"
    echo "Downloaded folder.jpg (and set as hidden)"
  else
    echo "Downloaded folder.jpg"
  fi
fi

if (( ${#files[@]} > 0 )); then
  mv -v "${files[@]}" "$dir"
fi

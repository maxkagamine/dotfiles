#!/bin/bash
#
# Copyright (c) Max Kagamine
# Licensed under the Apache License, Version 2.0
#
set -eo pipefail

# shellcheck source=mods/bash/.local/lib/common.sh
. ~/.local/lib/common.sh

help() {
  cat >&2 <<'EOF'
Usage: mkanimereadme <nyaa url or torrent file> [<dir>]

Creates a readme.md file in <dir> or the current directory.
EOF
  exit 1
}

get_torrent_comment() {
  # -0777 sets the record separator to undefined, and the /s modifier causes .
  # to match newlines. This will output empty string if there is no comment.
  perl -0777 -ne '/7:comment(\d+):/ && /7:comment$1:(.{$1})/s && print $1' "$1"
}

# Parse options
nyaa_url=
dir=.

parse_args \
  -h,--help \
  -- "$@"

for x in "${REST[@]}"; do
  case $x in
    https://*nyaa.si/*)
      if [[ ! $x =~ ^https://.*nyaa\.si/view/([[:digit:]]+) ]]; then
        throw 'unrecognized nyaa url'
      fi
      nyaa_url=${BASH_REMATCH[0]} # Remove hash / query string
      ;;
    *.torrent)
      nyaa_url=$(get_torrent_comment "$x")
      if [[ ! $nyaa_url =~ ^https://.*nyaa\.si/view/([[:digit:]]+) ]]; then
        throw 'torrent not from nyaa'
      fi
      nyaa_url=${BASH_REMATCH[0]} # Remove hash / query string
      ;;
    *)
      if [[ -d $x ]]; then
        dir=$x
      else
        throw "'$x' is neither an nyaa url/torrent nor a directory"
      fi
      ;;
  esac
done

if [[ ! $nyaa_url ]]; then
  throw 'üê±?'
fi

# Get nyaa info
if ! nyaa_html=$(curl -fsSLk --compressed "$nyaa_url"); then
  throw 'failed to fetch nyaa url'
fi
if ! nyaa_desc=$(grep -Pzo '(?s)(?<=id="torrent-description">).*?(?=</div>)' <<<"$nyaa_html" | tr -d '\0' | html-unescape) ||
   ! nyaa_hash=$(grep -Po '(?<=<kbd>)[0-9a-f]{40}(?=</kbd>)' <<<"$nyaa_html") ||
   ! nyaa_title=$(grep -Po '(?<=<title>).*?(?= :: )' <<<"$nyaa_html" | html-unescape); then
   throw 'failed to parse nyaa html'
fi

# Create readme
output="$dir/readme.md"
cat >"$output" <<EOF
# $nyaa_title

[\`$nyaa_hash\`]($nyaa_url)

## Source description

$nyaa_desc
EOF

echo "Created ${output#./}"

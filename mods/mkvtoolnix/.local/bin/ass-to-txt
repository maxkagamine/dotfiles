#!/bin/bash
#
# Copyright (c) Max Kagamine
# Licensed under the Apache License, Version 2.0
#
set -eo pipefail

# shellcheck source=mods/bash/.local/lib/common.sh
. ~/.local/lib/common.sh

help() {
  cat >&2 <<'EOF'
Usage: ass-to-txt [-k] [<subs>]

Strips out everything but the dialogue to make diffing subtitles easier. Inline
formatting is left as is.

Directories are expanded to contained *.ass files (non-recursive). If no paths
are given, the current directory is used.

Options:

  -k    Keep the .ass files. By default, the subs are removed or recycled and
        replaced with .txt files.
EOF
  exit 1
}

keep=

parse_args \
  -k 'keep=1' \
  -h,--help \
  -- "$@"

expand_directories \
  --glob '*.ass' --var paths --default . --required -- "${REST[@]}"

delete() {
  if command -v recycle &>/dev/null; then
    recycle --rm -fv "$@"
  else
    rm -fv "$@"
  fi
}

for f in "${paths[@]}"; do
  output="${f%.*}.txt"
  printf 'Converting \e[32m%s\e[m\n' "$f"

  if ! grep -P '^Dialogue:' "$f" | cut -d, -f10- > "$output"; then
    printf '\e[31mInvalid file: %s\e[m\n' "$f" >&2
    rm "$output"
    exit 1
  fi
done

if [[ ! $keep ]]; then
  delete "${paths[@]}"
fi

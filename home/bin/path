#!/bin/sh
set -e

getpaths() {
    reg.exe query "$1" /v PATH | grep PATH | \
        perl -pe 's/^.*?_SZ\s+//' | tr ';' '\n' | \
        sed 's/\\$//' | \
        #xargs -d'\n' -I{} cmd //c "echo {}" | sed 's/\s*$//' | \
        sed 's/%systemroot%/C:\\WINDOWS/gi' | \
        xargs -d'\n' wslpath
}

sysenv='HKLM\SYSTEM\CurrentControlSet\Control\Session Manager\Environment'
usrenv='HKCU\Environment'

readarray -t path <<<"$(tr ':' '\n' <<<"$PATH")"
readarray -t syspath <<<"$(getpaths "$sysenv" //v PATH)"
readarray -t usrpath <<<"$(getpaths "$usrenv" //v PATH)"

c_sys='\e[33m'; c_usr='\e[1;33m'; c_def='\e[m'
c_sys_inv='\e[31m'; c_usr_inv='\e[1;31m'

for p in "${path[@]}"; do
    color=''
    for x in "${usrpath[@]}"; do
        if [[ $x == $p ]]; then
            [[ -d $p ]] && color="$c_usr" || color="$c_usr_inv"
        fi
    done
    if [[ -z $color ]]; then
        for x in "${syspath[@]}"; do
            if [[ $x == $p ]]; then
                [[ -d $p ]] && color="$c_sys" || color="$c_sys_inv"
            fi
        done
    fi
    echo -e "${color}${p}${c_def}"
done

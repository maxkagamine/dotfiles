#!/bin/bash
set -eo pipefail

#region Passwordless sudo
sudo EDITOR=tee visudo -f /etc/sudoers.d/wsl >/dev/null <<EOF
Defaults  !env_reset
Defaults  !secure_path
%sudo     ALL=(ALL) NOPASSWD:ALL
EOF
#endregion

#region Network drive mount
if ! grep -q /mnt/s /etc/fstab; then
  sudo tee -a /etc/fstab >/dev/null <<<'S: /mnt/s drvfs defaults 0 0'
  sudo mkdir /mnt/s
  sudo mount -a
fi
#endregion

#region Auto-update packages
sudo tee /etc/cron.weekly/auto-update >/dev/null <<EOF
#!/bin/bash
if ! apt-get update && apt-get upgrade -y && apt-get autoclean; then
  notify-send 'auto-update failed'
fi
EOF
sudo chmod +x /etc/cron.weekly/auto-update
touch ~/.hushlogin
#endregion

echo 'deb [signed-by=/usr/share/keyrings/cloud.google.gpg] https://packages.cloud.google.com/apt cloud-sdk main' |
  sudo tee /etc/apt/sources.list.d/google-cloud-sdk.list >/dev/null
curl -fsS https://packages.cloud.google.com/apt/doc/apt-key.gpg |
  sudo tee /usr/share/keyrings/cloud.google.gpg >/dev/null

curl -fsSL https://deb.nodesource.com/setup_current.x | sudo -E bash -

sudo apt-get install -qy \
  bat \
  build-essential \
  fd-find \
  ffmpeg \
  fzf \
  gifsicle \
  google-cloud-cli \
  jq \
  libavif-bin \
  libimage-exiftool-perl \
  mediainfo \
  mkvtoolnix \
  nodejs \
  p7zip-rar \
  protobuf-compiler \
  python-is-python3 \
  python3-pip \
  shellcheck \
  stow \
  tree \
  unzip

mkdir -p ~/.local/bin

ln -fs /usr/bin/batcat ~/.local/bin/bat
ln -fs /usr/bin/fdfind ~/.local/bin/fd

curl -sSL https://dist.1-2.dev/imei.sh | sudo bash - # ImageMagick 7 (https://softcreatr.github.io/imei/)

wget https://github.com/BlackReloaded/wsl2-ssh-pageant/releases/latest/download/wsl2-ssh-pageant.exe \
  -O ~/.local/bin/wsl2-ssh-pageant.exe; chmod +x "$_"

wget https://github.com/yt-dlp/yt-dlp/releases/latest/download/yt-dlp \
  -O ~/.local/bin/yt-dlp; chmod +x "$_"

curl -fsSL https://starship.rs/install.sh | sh -s -- \
  -y -b ~/.local/bin >/dev/null

curl -fsSL https://api.github.com/repos/ImageOptim/gifski/releases/latest | \
  grep -Po '(?<="browser_download_url": ").*amd64.deb' | \
  wget -i - -O /tmp/gifski.deb
sudo apt install /tmp/gifski.deb
rm /tmp/gifski.deb

wget https://github.com/stuartleeks/wsl-notify-send/releases/latest/download/wsl-notify-send_windows_amd64.zip \
  -O /tmp/wsl-notify-send.zip
unzip -o /tmp/wsl-notify-send.zip wsl-notify-send.exe -d ~/.local/bin
rm /tmp/wsl-notify-send.zip

stow -R \
  bash \
  bat \
  dircolors \
  docker \
  fzf \
  git \
  nano \
  node \
  starship \
  sweetroll \
  utils \
  wsl \
  yt-dlp

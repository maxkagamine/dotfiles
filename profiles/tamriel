#!/bin/bash
set -e

#region Passwordless sudo
sudo EDITOR=tee visudo -f /etc/sudoers.d/wsl >/dev/null <<EOF
Defaults  !env_reset
Defaults  !secure_path
%sudo     ALL=(ALL) NOPASSWD:ALL
EOF
#endregion

#region Windows filesystem mount
sudo tee /etc/wsl.conf >/dev/null <<EOF
[automount]
options = "metadata,umask=022,fmask=111"
EOF

if [[ ! -d /mnt/s ]]; then
  echo 'S: /mnt/s drvfs metadata,umask=022,fmask=111 0 0' | \
    sudo tee -a /etc/fstab >/dev/null && \
    sudo mkdir /mnt/s && sudo mount -a
fi
#endregion

sudo apt-get update && sudo apt-get install -qy \
  stow \
  source-highlight \
  fd-find \
  fzf \
  jq

wget https://github.com/BlackReloaded/wsl2-ssh-pageant/releases/latest/download/wsl2-ssh-pageant.exe \
  -O ~/.ssh/wsl2-ssh-pageant.exe && chmod +x "$_"

stow -R \
  bash \
  git \
  nano \
  wsl
